限价下单

1、取tradecode tradeinfo，判断是否存在交易对，获取交易对信息

5、判断订单数量、手数、是否符合规范；保证金数量是否符合规范；委托量是否超过阈值；若不符合规范，则返回错误；（数量是否合规=手数档位是否包含：数量/手数比例=手数）（保证金档位是否包含：保证金/（数量/手数比例）=每手保证金）（阈值在tradeinfo）

2、读redis，获取行情对象

3、判断当前行情价和下单价格，方向（0=买涨，1=买跌），挂单价格必须在closeprice的0.08%范围外，委托价格>=closeprice*(1+固定数值/2) or 范围外，委托价格<=closeprice*(1-固定数值/2)；如>100.08%或<99.92%；限价不允许直接成交，状态为委托中

6、获取止盈止损价，若不存在止盈止损，则设置默认止损价，亏损80%；若存在，则判断止盈价、止损价是否符合80%规范
1)买涨：
委托价+固定数值=<止盈价=<0.8*保证金/手数比例+委托价
委托价-固定数值>止损价>委托价-0.8*保证金/手数比例
2)买跌：
委托价-0.8*保证金/手数比例<=止盈价<=委托价-固定数值
委托价+固定数值<=止损价<=0.8*保证金/手数比例+委托价

若不符合，则返回错误

7、判断是否过夜，若不过夜，则设置截止时间为第二天市场日终时间，若过夜，则把传入的过夜时间设置，判断时间是否符合规范

8、冻结保证金（冻结usdt，sourceCoin），新增资金流水，新增委托订单

9、返回委托成功信息

市价下单

1、取tradecode tradeinfo，判断是否存在交易对，获取交易对信息
2、读redis，获取行情对象
3、判断当前行情价，方向（涨=买，跌=卖），设置成交价为当前行情价（开仓，卖一价），设置状态为已成交，设置市价交易类型
4、根据购买数量，计算保证金（去常量里取保证金固定值），和传入保证金数量做比对，若不同，则返回错误，若相同，则继续
5、判断订单数量、手数比例、是否符合规范，若不符合规范，则返回错误；判断委托量，是否超过阈值
6、获取止盈止损价，若不存在止盈止损，则设置默认止损价，亏损80%；若存在，则判断止盈价、止损价是否符合80%规范，若不符合，则返回错误

1)买涨：
closeprice+固定数值=<止盈价=<0.8*保证金/手数比例+closeprice
closeprice-固定数值>止损价>closeprice-0.8*保证金/手数比例
2)买跌：
closeprice-0.8*保证金/手数比例<=止盈价<=closeprice-固定数值
closeprice+固定数值<=止损价<=0.8*保证金/手数比例+closeprice

7、判断是否过夜，若不过夜，则设置截止时间为第二天市场日终时间，若过夜，则把传入的过夜时间设置，判断时间是否符合规范
8、冻结保证金（冻结usdt，sourceCoin），新增资金流水，新增委托订单
9、返回成交信息

撤单

1、取tradecode tradeinfo，判断是否存在交易对，获取交易对信息
2、判断状态是否为挂单中
3、更新状态（乐观锁），执行撤单
4、返回撤单成功信息

手动平仓
1、取tradecode tradeinfo，判断是否存在交易对，获取交易对信息
2、获取当前行情价，根据方向判断，是否需要止损（买涨，则行情价<止损价；买跌，则行情价>止损价），若需要止损，则走强平方法；若不需要止损，则判断平仓是否成功，价格<买1，若价格不符，则返回失败
3、判断平仓价格和平仓数量，判断当前持仓量，是否)0且>平仓量，若数量不足，则返回失败
4、持仓-平仓量，解冻对应比例保证金，+-盈亏数额，杠杆账户入金或出金，若保证金-亏损额/保证金>=80%，不足，则减完为止，并设置订单状态为已平仓（爆仓）


风控代码逻辑

0、配置定时任务，调用风控入口方法
1、风控入口，查询行情，查询完成后，调用下一级方法，行情对象作为参数传入
2、查询订单列表，过滤掉已平仓和已撤单订单，得到订单集合，调用下一级方法，订单集合和行情对象作为参数传入
3、对订单集合分类
	1）委托中订单，调用委托中订单处理方法
	2）已成交订单，调用已成交订单处理方法
4、委托中处理订单
	1）委托中，判断是否有过期时间，若无过期时间，不处理；若有过期时间，判断当前时间是否大于过期时间，若大于，则判断是否能成交，若能成交则继续流程，若不满足成交条件，则发出【撤单消息】；
	2）过期时间判断结束后，流程继续，判断价格是否满足成交条件，若不满足成交条件，则跳过，若满足成交条件，则发出【成交消息】；成交条件，行情价作为买一价，下单价格>=买一价
	3）订阅【撤单消息】【成交消息】，处理撤单和成交；【成交消息】包含订单号和成交价格，【撤单消息】包含订单编号
5、已成交订单处理
	1）判断是否过夜，若过夜，则流程继续；若不过夜，则判断当前时间，是否超过第二日结算时间，若没超过，流程继续，若超过了，则发出【强平消息】，强平价格为当前行情价。
	2）判断当前价格，是否超过止盈止损范围，若超过，则按照止盈价或止损价，发出【强平消息】。
	3）订阅【强平消息】，处理强平订单；强平消息包含订单号，强平价格

风控消息处理

1、成交
1）获取订单对象，获取成交价格
2）变更订单状态，调用正常成交逻辑（改变状态，设置成交价格，时间等，资金流水不需变化，因为在下单时已处理）

2、平仓（强平）
1）获取订单对象，平仓价格
2）判断平仓价格是否在止盈止损范围内，若超过范围，则取止盈或止损价
3）执行平仓操作，逻辑参考手动平仓


3、撤单
1）获取订单对象
2）调用手动撤单接口


待完善功能
1、每天5：59分，收取过夜费(非过夜订单需要强平，风控已处理，这里只需要做过夜费判断，有效期判断不需要处理)，费用不足做强平（参考风控强平代码），
2、变更止盈止损（增加接口，修改止盈止损价格，有效区间判断参考成交逻辑）
3、撤单等操作加乐观锁
4、部分数值现在是固定值，后续改成可配置（比如下单时的价格偏移量）